<!doctype html>
<html>
<body>
<!--script type="text/javascript" src="platefont.js"></script-->
<style>
body {
  margin:0;
  padding:0;
  position:absolute;
  top:0;
  left:0;
  right:0;
  bottom:0;
  overflow:hidden;
}
#canvas {
  width:100%;
  height:100%;
  margin:0;
  padding:0;
}
</style>

<canvas id="canvas" width="512" height="256"></canvas>

<script>
var stampColors = ["#fad703","#d81c58","#16d9d2","#d44206","#2177c4"];
var stampMonth = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
}
function genSerial(text, month,year){
  var out = "", ser=1;

  /*if(text.length < 4){
    text+=stampMonth[mouth];
  }*/

  for (var i = 0, len = text.length; i < len; i++) {
    if(isNaN(text[i])){ //text
      ser *= text.charCodeAt(i);
    }
    else{
      ser *= parseInt( text[i] ) +1;
    }
  }
  ser *=(month+1)*42;
  ser *=year;

  out = String.fromCharCode( ser.toString().substr(0, 2)%24 + 65 );


  ser%=10000000;
  out += ser;

  return out;
}
function init(mode, text, design) {

  if(design == null || typeof design == "undefined") {
      design = {
        "name" : "Default",
        "version" : 1,
        "data" : {
            "size" : {"x" : 512, "y": 256},
            "text" : { "x" : 0.5, "y" : 0.5, "scale" : 1, "color" : "black", "limit" : 8},
            "diffuse" : {
                "spriteImg" : "vehicles/common/licenseplates/default/platefont_d.png",
                "backgroundImg" : "vehicles/common/licenseplates/west_coast_usa/licenseplate-default_d.png",
                "fillStyle" : "white"
            },

            "bump" : {
                "spriteImg" : "vehicles/common/licenseplates/default/platefont_n.png",
                "backgroundImg" : "vehicles/common/licenseplates/default/licenseplate-default_n.png",
                "fillStyle" : "rgb(0,0,255)"
            },

            "specular" : {
                "spriteImg" : "vehicles/common/licenseplates/default/platefont_s.png",
                "fillStyle" : "rgb(233,233,233)"
            }
        }
    };
  }

  if(design.data.text.limit) {
    text = text.substring(0, design.data.text.limit);
  }

  // preprocess the font file a bit to make the job below easier: array>map and parseInt()
  
  var font = design.data.characterLayout;
  
  font.charMap = {};
  for(var i = 0; i < font.chars.count; i++) {
      for(var d in font.chars.char[i]) {
        font.chars.char[i][d] = parseInt(font.chars.char[i][d])
      }
      font.charMap[parseInt(font.chars.char[i].id)] = font.chars.char[i];
  }
  //console.log(font);
  // load the canvas
  var canvas = document.getElementById('canvas');
  canvas.width = design.data.size.x;
  canvas.height = design.data.size.y;
  var ctx = canvas.getContext('2d');

  // figure out what images to load
  if(design.data[mode] == null) {
    console.log(mode + " is not a valid mode");
    return;
  }

  //console.log(design.data[mode]);

  ctx.fillStyle = design.data[mode].fillStyle;

  // draw static color background
  ctx.rect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle="#FFFF00";
  ctx.fill();

  var background = null;
  var sprites = null;

  var checkRender = function() {
    // dont render until all reasources are loaded
    if( (background && !background.isLoaded) || !sprites.isLoaded) return;

    if( background ) {
      ctx.drawImage(background, 0, 0, background.naturalWidth, background.naturalHeight, 0, 0, canvas.width, canvas.height);
    }

    // tint the character sheet if necesary
    var tintSprites = sprites;
    if( mode == "diffuse") {
      tintSprites = document.createElement('canvas');
      tintSprites.width = sprites.width;
      tintSprites.height = sprites.height;
      var tintCtx = tintSprites.getContext('2d');

      tintCtx.fillStyle = design.data.text.color;
      tintCtx.fillRect(0, 0, tintSprites.width, tintSprites.height);

      tintCtx.globalCompositeOperation = "multiply";
      tintCtx.drawImage(sprites, 0, 0);

      tintCtx.globalCompositeOperation = "destination-in";
      tintCtx.drawImage(sprites, 0, 0);

      var fsy = ctx.fillStyle;
      var d = new Date();
      d.setTime( d.getTime()+getRandomInt(2000000000,31579200000/*63158400000*/) );
      ctx.fillStyle = stampColors[d.getFullYear()%stampColors.length ]; 
      ctx.fillRect(415, 20, 70, 40);
      ctx.fillStyle = "#000"; 
      ctx.font="bold 20px Arial";
      ctx.fillText(d.getFullYear(),430,40);
      ctx.font="bold 10px Arial";
      ctx.fillText("C",420,30);
      ctx.fillText("A",420,40);

      //ctx.fillText("A"+getRandomInt(100000,9999999),425,55);
      ctx.fillText(genSerial(text, d.getMonth(),d.getFullYear()),425,55);

      ctx.fillStyle = "#f4f4f4"; 
      ctx.fillRect(35, 20, 60, 40);
      ctx.fillStyle = "rgb(0, 0, 102)"; 
      ctx.font="bold 20px Arial";
      ctx.fillText(stampMonth[d.getMonth()],45,47);

      ctx.fillStyle=fsy;
    }
    // walk the text
    var lineHeight = parseInt(font.common.lineHeight)
    var lineBase = parseInt(font.common.base)
    var scale = design.data.text.scale;

    // first: calculate the text width
    var textWidth = 0
    for(var ci = 0; ci < text.length; ci++) {
      var c = text.charCodeAt(ci)
      if(font.charMap[c] === undefined) continue;
      var glyph = font.charMap[c];
      textWidth += /*glyph.width * scale +*/ glyph.xadvance * scale + 2;
    }

    // now place the text in the center
    var x = canvas.width * design.data.text.x - textWidth * 0.5
    var y = canvas.height * design.data.text.y - lineHeight * 0.5
    //console.log('starting pos:',x, y, textWidth, canvas.width, lineHeight, canvas.height)
    for(var ci = 0; ci < text.length; ci++) {
      var c = text.charCodeAt(ci)

      // find the correct char in the atlas
      if(font.charMap[c] === undefined) {
        console.log("character not found: ", c)
        continue;
      }
      var glyph = font.charMap[c];
      //console.log(c, glyph)

      // and paint it
      var w = glyph.width;
      var h = glyph.height;
      ctx.drawImage(tintSprites,
        glyph.x, glyph.y, w, h,
        x + glyph.xoffset * scale, y - (lineHeight - lineBase) - glyph.yoffset * scale, w * scale, h * scale);

      // move to the right: TODO: move to the next line
      x += glyph.xadvance * scale + 2;
    }

    if(typeof beamng !== 'undefined') {
      beamng.uiUpdate();
      beamng.uiDestroy();
    }
  }

  // load background image
  if(design.data[mode].backgroundImg !== undefined) {
    background = new Image();
    background.src = "local://local/" + design.data[mode].backgroundImg;
    background.addEventListener("load", function() { background.isLoaded = true; checkRender(); });
  }

  // then the sprites / text
  sprites = new Image();
  sprites.src = "local://local/" + design.data[mode].spriteImg;
  sprites.addEventListener("load", function() { sprites.isLoaded = true; checkRender(); }, false);
  
}
/// for debugging inside the browser:
if(typeof beamng === 'undefined') {
  var testText = 'TEST 123';
  init('diffuse', testText);
  //init('bump', testText);
  //init('specular', testText);
}
</script>
</body></html>
